self.dropdownDialogs=[];(function(c){var a=0;var b=[];var d=[];window.dropdownDialog=function(j,h,e,f){this.elem=c(h);if(this.elem.length==0){return false}this.setPosition(e);this.uri=j;this.triangle_position="center";this.closeButton=true;this.html="";var g;if(typeof f!="undefined"){for(g in f){this[g]=f[g]}}this.id=randomString(20);this.Init();this.show(j);return this};dropdownDialog.prototype={checkEdit:function(){if(this.dropdown.find("> div > .content > div").html()!=this.html){this.html=this.dropdown.find("> div > .content > div").html();this.definePosition(this.position)}},Init:function(){if(typeof profiler!="undefined"){profiler.mark("dropdownDialog.Init")}var f=this;if(this.elem.attr("id")==undefined){this.elem.attr("id","link_dropdown_dialog_"+a);a++}if(c("#dropdownDialog_"+this.elem.attr("id")).length==0){getDocRoot().append('<div id="dropdownDialog_'+this.elem.attr("id")+'" class="dropdownDialog windowindex"></div>');this.dropdown=c("#dropdownDialog_"+this.elem.attr("id"));this.dropdown.append('<div><div class="content"></div></div>');this.dropdown.css({display:"none",position:"absolute"});this.dropdown.find(" > div > .content").resize(function(){f.definePosition()});c(window).resize(function(){f.definePosition()});var g=true}else{this.dropdown=c("#dropdownDialog_"+this.elem.attr("id"));var g=false}d[this.dropdown.attr("id")]=this;b[this.elem.attr("id")]=this;self.dropdownDialogs[this.id]=this;if(!this.elem.hasClass("noAutoHide")&&this.autohide!=false){var e=this;CallonDocumentClick(function(){e.hide()},[this.dropdown,this.elem])}if(this.elem.hasClass("noIEAjax")){if(c.browser.msie&&getInternetExplorerVersion()<9){location.href=this.uri}}if(g){this.setLoading()}if(typeof profiler!="undefined"){profiler.unmark("dropdownDialog.Init")}},definePosition:function(e){if(typeof profiler!="undefined"){profiler.mark("dropdownDialog.definePosition")}if(e!=null){this.setPosition(e)}if(this.elem.css("position")=="fixed"){throw"dropdownDialog does not support elements with position:fixed yet";return false}if(this.elem.css("display")=="none"){throw"dropdownDialog does not support elements with display:none yet";return false}var h=this.elem.offset().top;var g=this.elem.offset().left;var f=this.elem.outerHeight();var k=this.elem.outerWidth();var j=c(document).width()-g;if(this.position=="auto"){if(g<100&&h>100){e="right"}else{if(j<100&&h>100){e="left"}else{if(h>(c(window).height()*0.7)){e="bottom"}else{e="top"}}}}else{e=this.position}if(e=="bottom"){var h=this.elem.offset().top;if((h-this.dropdown.height()-2)<-10){e="top"}}this.dropdown.find(" > div").attr("class","");this.dropdown.find(" > div").addClass("position_"+e);this.moveDropdown(e);if(typeof profiler!="undefined"){profiler.unmark("dropdownDialog.definePosition")}},setPosition:function(e){switch(e){case"left":this.position="left";break;case"center":case"top":this.position="top";break;case"right":this.position="right";break;case"bottom":this.position="bottom";break;default:this.position="auto"}},moveDropdown:function(k){if(typeof profiler!="undefined"){profiler.mark("dropdownDialog.moveDropdown")}this.triangle_position="center";var l=this.elem.offset().top;var f=this.elem.offset().left;var h=this.elem.outerHeight();var m=this.elem.outerWidth();this.dropdown.find(" > div > .triangle").remove();var n=(this.dropdown.css("display")=="block");this.dropdown.css({display:"block",top:"-1000px"});switch(k){case"bottom":var o=l-this.dropdown.height()-2;case"top":case"center":if(typeof o=="undefined"){var o=l+h-2}var g=f-(this.dropdown.find(" > div > .content").width()/2)+(m/2)-3;var j=this.dropdown.find(" > div > .content").outerWidth();this.dropdown.find(" > div > .content").css("width",this.dropdown.find(" > div > .content").width());this.dropdown.css("display","none");if(j+g>c(document).width()){this.triangle_position="right";var g=f+m-j+14}if(g<0){this.triangle_position="left";var g=f-18}this.dropdown.css({top:o,left:g,right:"auto",bottom:"auto"});break;case"left":var o=l-(this.dropdown.find(" > div > .content").height()/2)+(h/2);var e=this.dropdown.find(" > div > .content").outerWidth();this.dropdown.find(" > div > .content").css("width",this.dropdown.find(" > div > .content").width());var p=f+2-e;this.dropdown.css({display:"none",top:o,left:p,right:"auto",bottom:"auto"});break;case"right":var o=l-(this.dropdown.find(" > div > .content").height()/2)+(h/2);var g=f+m-2;this.dropdown.css({display:"none",top:o,left:g,right:"auto",bottom:"auto"});break}this.dropdown.find(" > div").prepend('<div class="triangle_position_'+this.triangle_position+' triangle"><div></div></div>');if(n){this.dropdown.css("display","block")}else{this.dropdown.fadeIn("fast")}if(typeof profiler!="undefined"){profiler.unmark("dropdownDialog.moveDropdown")}},setLoading:function(){this.dropdown.css("display","block");this.closeButton=false;this.setContent('<img src="system/templates/css/images/loading_big.gif" alt="loading" style="display: block;margin: auto;" />');this.closeButton=true},setContent:function(f){if(typeof profiler!="undefined"){profiler.mark("dropdownDialog.setContent")}this.dropdown.find(" > div > .content").css("width","");if(typeof f=="string"){this.dropdown.find(" > div > .content").html("<div>"+f+"</div>")}else{this.dropdown.find(" > div > .content").html("");c(f).wrap("<div></div>").appendTo(this.dropdown.find(" > div > .content"))}this.dropdown.find(" > div  > .content > .close").remove();if(!this.elem.hasClass("hideClose")&&this.closeButton){this.dropdown.find(" > div > .content > div").prepend('<a class="close" href="javascript:;">&times;</a>')}var e=this;this.dropdown.find(".close, *[name=cancel]").click(function(){e.hide();return false});if(this.dropdown.css("display")!="none"){this.definePosition(this.position)}if(typeof profiler!="undefined"){profiler.unmark("dropdownDialog.setContent")}},show:function(f){if(this.dropdown.css("display")=="block"&&this.dropdown.attr("name")==f){return false}this.setLoading();this.dropdown.attr("name",f);var e;for(e in this.players){if(typeof this.players[e]=="object"){if(typeof this.players[e].regexp!="undefined"&&this.players[e].regexp.test(this.uri)){return this.players[e].method(this,this.uri)}}}return this.player_ajax(this.uri)},removeHelper:function(){this.dropdown.remove()},remove:function(){d[this.dropdown.attr("id")]=null;b[this.elem.attr("id")]=null;self.dropdownDialogs[this.id]=null;var e=this;this.dropdown.fadeOut("fast",function(){e.removeHelper()})},hide:function(){this.remove()},player_html:function(e){this.setContent(c(e))},player_img:function(h){var f=h;var e=new Image();var g=this;e.onload=function(){var j=e.height;var l=e.width;var k=l/j;var n=c(window).height()-300;var m=c(window).width()-400;if(j>n){var j=n;var l=j*k}g.setContent('<img src="'+f+'" alt="'+f+'" height="'+j+'" width="'+l+'" />')};e.onerror=function(){g.setContent("<h3>Connection error!</h3> <br /> Please try again later!")};e.src=f},player_ajax:function(f){var e=this;if(f.indexOf("?")==-1){f+="?dropdownDialog=1&dropElem="+this.id}else{f+="&dropdownDialog=1&dropElem="+this.id}c.ajax({url:f,type:"get",error:function(g,j,h){if(j=="timeout"){e.setContent("Error when fetching data from the server: <br /> The response timed out.")}else{if(j=="abort"){e.setContent("Error when fetching data from the server: <br /> The request was aborted.")}else{e.setContent("Error when fetching data from the server: <br /> Failed to fetch data from the server.")}}},dataType:"html",success:function(h,n,j){LoadAjaxResources(j);var g=j.getResponseHeader("content-type");if(g=="text/x-json"){try{var k=eval_global("("+h+")");var h=k.content;if(k.position!=null){e.position=k.position}if(k.closeButton!=null){e.closeButton=k.closeButton}e.setContent(h);if(typeof k.exec!="undefined"){eval_global("("+k.exec+")").call(e)}}catch(l){e.setContent("error")}}else{if(g=="text/javascript"){var m=eval_global("(function() { "+h+"})");m.call(this)}else{e.setContent(h)}}RunAjaxResources(j)}})},players:[{regexp:/^#/,method:function(f,e){f.player_html(e)}},{regexp:/^.*\.(img|png|jpg|gif|bmp)$/i,method:function(f,e){f.player_img(e)}}]};dropdownDialog.get=function(e){if(typeof d[e]!="undefined"){return d[e]}else{if(typeof b[e]!="undefined"){return b[e]}else{if(typeof self.dropdownDialogs[e]!="undefined"){return self.dropdownDialogs[e]}else{return false}}}};c.fn.extend({dropdownDialog:function(e){if(typeof e=="string"){e={uri:e}}var h={uri:"",position:null};var j=c.extend(h,e);var f=this;var g={instances:[],hide:function(){for(i in g.instances){g.instances[i].hide()}},remove:function(){for(i in g.instances){g.instances[i].remove()}}};this.each(function(){var k=new dropdownDialog(j.uri,this,j.position);g.instances.push(k)});return g}})})(jQuery);